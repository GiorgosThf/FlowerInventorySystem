@page
@model IndexModel
@{
  ViewData["Title"] = "Flowers";
  var total = Model.Items.Count;
}

<!-- Header -->
<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
  <div>
    <h2 class="mb-0">Flowers</h2>
    <div class="text-muted small">Results: <strong>@total</strong></div>
  </div>
  <a class="btn btn-success" asp-page="Create"><i class="bi bi-plus-circle me-1"></i>Add Flower</a>
</div>

<!-- Toolbar -->
<form id="filtersForm" method="get" class="card shadow-sm border-0 mb-3">
  <div class="card-body d-flex flex-wrap align-items-center gap-2">
    <!-- search -->
    <div class="input-group" style="max-width: 420px;">
      <span class="input-group-text bg-white"><i class="bi bi-search"></i></span>
      <input name="q" value="@Model.Q" class="form-control" placeholder="Search name or type..."/>
    </div>

    <div class="d-flex align-items-center gap-2">
      <label class="text-muted small mb-0">Category</label>
      <select name="CategoryId" class="form-select" style="min-width: 220px;"
              onchange="document.getElementById('filtersForm').submit()">
        <option value="">All categories</option>
        @foreach (var c in Model.CategoryList)
        {
          <option value="@c.Id" selected="@(Model.CategoryId == c.Id)">@c.Name</option>
        }
      </select>
    </div>

    <!-- sort -->
    <div class="ms-auto d-flex align-items-center gap-2">
      <label class="text-muted small mb-0">Sort by</label>
      <select name="sort" class="form-select" style="min-width: 180px;"
              onchange="document.getElementById('filtersForm').submit()">
        <option value="">Default</option>
        <option value="name" selected="@((Model.Sort ?? "") == "name")">Name ↑</option>
        <option value="name_desc" selected="@((Model.Sort ?? "") == "name_desc")">Name ↓</option>
        <option value="type" selected="@((Model.Sort ?? "") == "type")">Type ↑</option>
        <option value="type_desc" selected="@((Model.Sort ?? "") == "type_desc")">Type ↓</option>
        <option value="price" selected="@((Model.Sort ?? "") == "price")">Price ↑</option>
        <option value="price_desc" selected="@((Model.Sort ?? "") == "price_desc")">Price ↓</option>
        <option value="category" selected="@((Model.Sort ?? "") == "category")">Category ↑</option>
        <option value="category_desc" selected="@((Model.Sort ?? "") == "category_desc")">Category ↓</option>
      </select>

      <button class="btn btn-primary"><i class="bi bi-funnel me-1"></i>Apply</button>
      @if (!string.IsNullOrWhiteSpace(Model.Q) || Model.CategoryId.HasValue || !string.IsNullOrWhiteSpace(Model.Sort))
      {
        <a class="btn btn-outline-secondary" asp-page="./Index"><i class="bi bi-x-circle me-1"></i>Clear</a>
      }
    </div>
  </div>
</form>

<!-- Results -->
@if (total == 0)
{
  <div class="card border-0 shadow-sm">
    <div class="card-body text-center py-5">
      <div class="display-6 mb-2">🌻</div>
      <h5 class="mb-1">No flowers found</h5>
      @if (!string.IsNullOrWhiteSpace(Model.Q) || Model.CategoryId.HasValue || !string.IsNullOrWhiteSpace(Model.Sort))
      {
        <p class="text-muted mb-3">Try clearing filters or adjusting your search.</p>
        <a class="btn btn-outline-secondary" asp-page="./Index">Clear filters</a>
      }
      else
      {
        <p class="text-muted mb-3">Get started by adding your first flower.</p>
        <a class="btn btn-success" asp-page="Create"><i class="bi bi-plus-circle me-1"></i>Add Flower</a>
      }
    </div>
  </div>
}
else
{
  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
      <tr>
        <th style="width:64px;"></th>
        <th>Name</th>
        <th>Type</th>
        <th class="text-end">Price</th>
        <th>Category</th>
        <th class="text-end">Actions</th>
      </tr>
      </thead>
      <tbody>
      @foreach (var f in Model.Items)
      {
        <tr class="row-hover">
          <td>
            <dd class="col-sm-9">
              <img
                src=@(f.ImagePath is null or ""
                  ? "http://localhost:9000/images/default/default-flower.jpg"
                  : $"http://localhost:9000/images/{f.ImagePath}")
                style="max-width:100px"
                alt="@f.Name"
                class="thumb"/>
            </dd>
          </td>
          <td>@f.Name</td>
          <td><span class="badge badge-soft">@f.Type</span></td>
          <td class="text-end">@f.Price.ToString("0.00")</td>
          <td>@f.Category?.Name</td>
          <td class="text-end">
            <a class="btn btn-sm btn-outline-secondary bi-eye"
               data-bs-toggle="modal"
               data-bs-target="#flowerDetails-@f.Id">
              Details
            </a>
            <a class="btn btn-sm btn-outline-primary bi-pencil-square"
               data-bs-toggle="modal"
               data-bs-target="#flowerEdit-@f.Id">Edit</a>

            <a class="btn btn-sm bi-trash btn-outline-danger"
               data-bs-toggle="modal"
               data-bs-target="#flowerDelete-@f.Id">
              Delete
            </a>
          </td>
        </tr>
      }
      </tbody>
    </table>
    @foreach (var f in Model.Items)
    {
      <partial name="~/Pages/Flowers/_FlowerDetailsModal.cshtml" model="f"/>
    }
    @foreach (var f in Model.Items)
    {
      <partial name="~/Pages/Flowers/_FlowerDeleteModal.cshtml" model="f"/>
    }
    @foreach (var f in Model.Items)
    {
      <partial name="~/Pages/Flowers/_FlowerEditModal.cshtml"
               model="new Edit.FlowerEditModel { Flower = f, Categories = Model.CategoryList }"/>
    }
  </div>
}
